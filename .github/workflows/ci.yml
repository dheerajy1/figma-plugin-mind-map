name: CI

on:
  pull_request:
    branches:
      - developer
      - main
  push:
    branches:
      - developer
      - main
      - feature/**

jobs:

  # ---------------------------
  # 1) Build & Lint Job
  # ---------------------------
  build_and_lint:
    name: Build & Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - run: pnpm install
      - run: pnpm build
      - run: pnpm lint

  # ---------------------------
  # 2) Enforce Branch Naming
  # Only allow feature/* → developer → main
  # ---------------------------
  validate_branch_name:
    name: Validate Branch Naming
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: "Check source branch name"
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch name: $BRANCH"
          if [[ "$BRANCH" != feature/* && "$BRANCH" != developer && "$BRANCH" != main ]]; then
            echo "❌ Invalid branch name. Allowed:"
            echo " - feature/*"
            echo " - developer"
            echo " - main"
            exit 1
          fi
        shell: bash

  # ---------------------------
  # 3) Enforce Semantic PR Title
  # "feat:", "fix:", "chore:", "refactor:", etc.
  # ---------------------------
  validate_pr_title:
    name: Validate PR Title Format
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: "Check PR Title"
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ---------------------------
# 4) Validate PR Template + Auto Promote Draft
# ---------------------------
  verify_pr_template:
    name: Validate PR Template
    runs-on: ubuntu-latest
    if: >
      (github.event.pull_request.base.ref == 'developer' ||
      github.event.pull_request.base.ref == 'main')

    steps:
      - name: Read PR Body
        id: prcheck
        run: |
          body=$(jq -r '.pull_request.body' "$GITHUB_EVENT_PATH")

          # Check Types of changes (at least one box checked)
          types_checked=$(echo "$body" | grep -E '^\s*-\s*\[x\]\s*Bugfix|^\s*-\s*\[x\]\s*New feature|^\s*-\s*\[x\]\s*Breaking change|^\s*-\s*\[x\]\s*Documentation Update' || true)
          if [ -z "$types_checked" ]; then
            echo "types_missing=true" >> $GITHUB_OUTPUT
          else
            echo "types_missing=false" >> $GITHUB_OUTPUT
          fi

          # Check Checklist (all must be checked)
          checklist_total=$(echo "$body" | grep -E '^\s*-\s*\[.\]' | wc -l)
          checklist_checked=$(echo "$body" | grep -E '^\s*-\s*\[x\]' | wc -l)
          if [ "$checklist_total" -ne "$checklist_checked" ]; then
            echo "checklist_missing=true" >> $GITHUB_OUTPUT
          else
            echo "checklist_missing=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if Types of Changes Missing
        if: steps.prcheck.outputs.types_missing == 'true'
        run: |
          echo "❌ At least one 'Types of changes' checkbox must be selected."
          exit 1

      - name: Fail if Checklist Incomplete
        if: steps.prcheck.outputs.checklist_missing == 'true'
        run: |
          echo "❌ All Checklist items must be completed."
          exit 1

      - name: Leave Comment if PR Template Invalid
        if: steps.prcheck.outputs.types_missing == 'true' || steps.prcheck.outputs.checklist_missing == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ⚠️ **PR Template validation failed.**
            Please ensure:
            - At least one box in **Types of changes** is checked.
            - All boxes in **Checklist** are checked.

      - name: Auto-Mark PR Ready for Review When Template Complete
        if: steps.prcheck.outputs.types_missing == 'false' && steps.prcheck.outputs.checklist_missing == 'false' && github.event.pull_request.draft == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              draft: false
            })
